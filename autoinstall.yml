#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: mbp14-3
    username: hkh
    password: ""
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ''
  timezone: America/New_York
  apt:
    primary:
      - arches: [amd64]
        uri: http://archive.ubuntu.com/ubuntu
  ssh:
    install-server: false

  storage:
    layout:
      name: existing
    config:
      - id: disk0
        type: disk
        match:
          path: /dev/nvme0n1
        ptable: gpt
        preserve: true

      # EFI (nvme0n1p1) — reuse
      - id: part-esp
        type: partition
        device: disk0
        number: 1
        preserve: true
        grub_device: true
      - id: fs-esp
        type: format
        fstype: fat32
        volume: part-esp
        preserve: true
      - id: mnt-esp
        type: mount
        device: fs-esp
        path: /boot/efi

      # macOS (nvme0n1p2) untouched — no entry

      # swap (nvme0n1p3) — reuse
      - id: part-swap
        type: partition
        device: disk0
        number: 3
        preserve: true
      - id: fs-swap
        type: format
        fstype: swap
        volume: part-swap
        preserve: true
      - id: mnt-swap
        type: mount
        device: fs-swap
        path: none

      # root (nvme0n1p4) — reformat to Btrfs
      - id: part-root
        type: partition
        device: disk0
        number: 4
        wipe: superblock
      - id: fs-root
        type: format
        fstype: btrfs
        volume: part-root
        label: root
      - id: mnt-root
        type: mount
        device: fs-root
        path: /
        options: [noatime,ssd,compress=zstd]

  packages:
    - linux-generic-hwe-24.04
    - btrfs-progs
    - build-essential
    - dkms
    - git
    - curl
    - wget
    - pipewire-audio
    - pipewire-pulse
    - wireplumber
    - iw
    - mbfan
    - bolt
    - pulseaudio-utils

  user-data:
    disable_root: true
    package_upgrade: true
